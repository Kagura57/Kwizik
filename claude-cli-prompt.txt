# MUSIC QUIZ MULTIPLAYER â€” FULL STACK PROJECT

## CONTEXT
You are a senior full-stack developer. Build a complete, production-ready multiplayer music quiz web application optimized for mobile party use (friends playing together in the same room on their phones).
This is a monorepo with a separate frontend and backend.

---

## TECH STACK (mandatory, do not deviate)

### Frontend
- **Runtime**: Bun
- **Bundler**: Vite 8.0.0-beta (Rolldown engine â€” use `resolve.rolldownOptions` not `rollupOptions`)
- **Framework**: React 19 (use `use()` hook, `useOptimistic`, `useFormStatus` where relevant)
- **Language**: TypeScript 5.5+ (strict mode, `noUncheckedIndexedAccess: true`)
- **Router**: TanStack Router v1 (file-based routing, fully type-safe)
- **Data Fetching**: TanStack React Query v5 + native `fetch` (no axios, no SWR)
- **Styling**: Tailwind CSS v4 + shadcn/ui (tailwind v4 config syntax)
- **State**: Zustand v5
- **Animations**: Motion (formerly Framer Motion)
- **Audio**: Howler.js
- **Linter**: Oxlint
- **Formatter**: Biome (for formatting, since oxfmt is not yet production-ready for JSX/TSX)

> âš ï¸ Note: oxfmt does not yet support JSX/TSX as of mid-2024. Use Biome for formatting and Oxlint for linting. Configure them to not conflict.

### Backend
- **Runtime**: Bun
- **Framework**: Elysia.js (built for Bun, type-safe, fast)
- **Language**: TypeScript 5.5+ (strict)
- **Database**: Supabase (PostgreSQL + Realtime + Storage)
- **Auth**: Supabase Auth (JWT)
- **Cache**: Bun built-in `Map` + Redis via Upstash (free tier) for cross-instance cache
- **Linter/Formatter**: same Oxlint + Biome config

### Infrastructure
- **Package Manager**: Bun (workspaces monorepo)
- **Hosting Frontend**: Railway (static build served by Railway nginx)
- **Hosting Backend**: Railway (Bun container)
- **Database**: Supabase (external, free tier)
- **CI/CD**: GitHub Actions â†’ Railway deploy on push to `main`
- **Repo**: GitHub (monorepo)

---

## MONOREPO STRUCTURE

```
music-quiz/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                          # Frontend React 19 + TanStack Router
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/               # TanStack Router file-based routes
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __root.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx         # Home: Create / Join
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ join.tsx          # Join room page
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create.tsx        # Create room page
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ lobby/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ $roomCode.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ play/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ $roomCode.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ results/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ $roomCode.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ game/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AudioPlayer.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuizRound.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ VideoReveal.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Scoreboard.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Timer.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AnswerInput.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PlayerList.tsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ lobby/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RoomCode.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QRCode.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ WaitingRoom.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ui/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ MobileLayout.tsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ PartyButton.tsx
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ AnimatedBackground.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useGameRoom.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useAudio.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ useRealtime.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ useTimer.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ gameStore.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ supabase.ts       # Supabase client (browser)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ api.ts            # Typed fetch wrapper to backend
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ fuzzy.ts          # Client-side answer matching
â”‚   â”‚   â”‚   â”œâ”€â”€ queries/              # TanStack Query queryOptions definitions
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ room.queries.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tracks.queries.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ player.queries.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts          # Shared types (re-exported from packages/shared)
â”‚   â”‚   â”‚   â”œâ”€â”€ routeTree.gen.ts      # Auto-generated by TanStack Router
â”‚   â”‚   â”‚   â”œâ”€â”€ main.tsx
â”‚   â”‚   â”‚   â””â”€â”€ globals.css
â”‚   â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”‚   â”œâ”€â”€ sounds/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ correct.mp3
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ wrong.mp3
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ countdown.mp3
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ reveal.mp3
â”‚   â”‚   â”‚   â””â”€â”€ manifest.json         # PWA
â”‚   â”‚   â”œâ”€â”€ index.html
â”‚   â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ api/                          # Backend Elysia.js + Bun
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ routes/
â”‚       â”‚   â”‚   â”œâ”€â”€ quiz.ts           # POST /quiz/create, /quiz/join, /quiz/answer
â”‚       â”‚   â”‚   â”œâ”€â”€ room.ts           # GET /room/:code, PATCH /room/:code
â”‚       â”‚   â”‚   â”œâ”€â”€ music/
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ search.ts     # Unified search across all providers
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ spotify.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ deezer.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ apple.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ tidal.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ytmusic.ts
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ youtube.ts    # Video clip search
â”‚       â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚       â”‚   â”‚   â””â”€â”€ stripe.ts
â”‚       â”‚   â”œâ”€â”€ services/
â”‚       â”‚   â”‚   â”œâ”€â”€ MusicAggregator.ts  # Unified API across all providers
â”‚       â”‚   â”‚   â”œâ”€â”€ TrackCache.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ RoomManager.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ ScoreCalculator.ts
â”‚       â”‚   â”‚   â””â”€â”€ FuzzyMatcher.ts
â”‚       â”‚   â”œâ”€â”€ lib/
â”‚       â”‚   â”‚   â”œâ”€â”€ supabase.ts       # Supabase admin client
â”‚       â”‚   â”‚   â”œâ”€â”€ upstash.ts        # Redis cache
â”‚       â”‚   â”‚   â”œâ”€â”€ rate-limiter.ts
â”‚       â”‚   â”‚   â””â”€â”€ logger.ts
â”‚       â”‚   â”œâ”€â”€ middleware/
â”‚       â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚       â”‚   â”‚   â””â”€â”€ cors.ts
â”‚       â”‚   â”œâ”€â”€ types/
â”‚       â”‚   â”‚   â””â”€â”€ index.ts
â”‚       â”‚   â””â”€â”€ index.ts              # Elysia app entry
â”‚       â”œâ”€â”€ tsconfig.json
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ shared/                       # Shared types + constants
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ types.ts
â”‚       â”‚   â”œâ”€â”€ constants.ts          # Categories, game config
â”‚       â”‚   â””â”€â”€ events.ts             # Realtime event types
â”‚       â”œâ”€â”€ tsconfig.json
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ migrations/
â”‚       â””â”€â”€ 001_initial.sql
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ deploy-web.yml
â”‚       â””â”€â”€ deploy-api.yml
â”œâ”€â”€ .oxlintrc.json
â”œâ”€â”€ biome.json
â”œâ”€â”€ bunfig.toml
â”œâ”€â”€ railway.toml
â””â”€â”€ package.json                      # Bun workspace root
```

---

## VITE 8 BETA CONFIG (Rolldown)

```typescript
// apps/web/vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { TanStackRouterVite } from '@tanstack/router-plugin/vite'

export default defineConfig({
  plugins: [
    TanStackRouterVite({ routesDirectory: './src/routes' }),
    react(),
  ],
  // Vite 8 with Rolldown: use rolldownOptions instead of rollupOptions
  build: {
    rolldownOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          tanstack: ['@tanstack/react-query', '@tanstack/react-router'],
        }
      }
    }
  },
  resolve: {
    alias: { '@': '/src' }
  }
})
```

---

## BUN WORKSPACE CONFIG

```toml
# bunfig.toml
[install]
exact = true

[run]
bun = true
```

```json
// package.json (root)
{
  "name": "music-quiz",
  "private": true,
  "workspaces": ["apps/*", "packages/*"],
  "scripts": {
    "dev": "bun run --filter '*' dev",
    "dev:web": "bun run --filter web dev",
    "dev:api": "bun run --filter api dev",
    "build": "bun run --filter '*' build",
    "lint": "oxlint .",
    "format": "biome format --write .",
    "typecheck": "bun run --filter '*' typecheck"
  }
}
```

---

## LINTER & FORMATTER CONFIG

```json
// .oxlintrc.json
{
  "plugins": ["react", "react-hooks", "jsx-a11y", "unicorn"],
  "rules": {
    "no-unused-vars": "error",
    "react-hooks/rules-of-hooks": "error",
    "react-hooks/exhaustive-deps": "warn",
    "unicorn/no-array-for-each": "warn"
  },
  "ignorePatterns": ["dist/", "node_modules/", "src/routeTree.gen.ts"]
}
```

```json
// biome.json
{
  "$schema": "https://biomejs.dev/schemas/1.8.0/schema.json",
  "formatter": {
    "enabled": true,
    "indentStyle": "space",
    "indentWidth": 2,
    "lineWidth": 100
  },
  "javascript": {
    "formatter": {
      "quoteStyle": "single",
      "trailingCommas": "es5",
      "semicolons": "always"
    }
  },
  "files": {
    "ignore": ["dist/", "node_modules/", "src/routeTree.gen.ts"]
  },
  "linter": { "enabled": false }
}
```

---

## MUSIC APIs â€” ALL PROVIDERS

### Provider Priority & Fallback Chain
```
Search order:   Spotify â†’ Deezer â†’ Apple Music â†’ Tidal â†’ YT Music
Preview order:  Spotify (30s) â†’ Deezer (30s) â†’ Apple Music (30s) â†’ Tidal (30s) â†’ YouTube Audio
Video clip:     YouTube Data API v3
```

### 1. Spotify
```typescript
// OAuth2 Client Credentials
// Preview: track.preview_url (30s MP3, always free)
// Rate limit: ~180 req/min (conservative estimate)
// Endpoints used: /search, /tracks, /recommendations
```

### 2. Deezer
```typescript
// No auth for public search
// Preview: track.preview (30s MP3)
// Rate limit: ~50 req/5s
// Endpoints: /search, /track/{id}
```

### 3. Apple Music
```typescript
// Requires: Apple Developer Account + MusicKit Key
// Auth: JWT with private key (ES256, kid from Apple Dev Portal)
// Preview: attributes.previews[0].url (30s AAC)
// Rate limit: 3000 req/hour per token
// Endpoints: /v1/catalog/{storefront}/search
// Note: Storefront = 'fr' for French content
```

### 4. Tidal
```typescript
// Requires: Tidal Developer Account (free tier available)
// Auth: OAuth2 Client Credentials
// Preview: tidalPreviewUrl (30s, not always available on free tier)
// Rate limit: 1000 req/day on free tier â€” use sparingly as last resort
// Endpoints: /v2/searchresults/{query}/relationships/tracks
```

### 5. YouTube Music
```typescript
// No official API â€” use YouTube Data API v3 with music category filter
// videoCategoryId: '10' (Music)
// Use for: finding official clips AND as preview fallback (extract audio via URL)
// Rate limit: 10,000 units/day (search = 100 units)
// Strategy: YouTube is used for VIDEO CLIPS primarily, not audio previews
```

### MusicAggregator Service
```typescript
// services/MusicAggregator.ts
// Unified interface across all providers:

interface MusicProvider {
  name: string;
  search(query: string, category: string, limit: number): Promise<NormalizedTrack[]>;
  getPreviewUrl(trackId: string): Promise<string | null>;
}

interface NormalizedTrack {
  title: string;
  artist: string;
  album?: string;
  releaseYear?: number;
  popularity?: number;
  // Provider-specific IDs
  spotifyId?: string;
  deezerId?: string;
  appleId?: string;
  tidalId?: string;
  // Preview sources (ordered by quality)
  previewUrls: { provider: string; url: string }[];
  youtubeVideoId?: string;   // for clip reveal
  youtubeStartTime?: number;
}

// Search all providers in parallel, deduplicate by (title + artist),
// merge preview URLs, rank by combined popularity score
async function aggregateSearch(query: string, category: string): Promise<NormalizedTrack[]> {
  const results = await Promise.allSettled([
    spotifyProvider.search(query, category, 20),
    deezerProvider.search(query, category, 20),
    appleMusicProvider.search(query, category, 20),
    // Tidal last (low rate limit)
    tidalProvider.search(query, category, 10),
  ]);
  // Merge, deduplicate, rank, return top 50
}
```

---

## TANSTACK ROUTER SETUP

```typescript
// apps/web/src/main.tsx
import { StrictMode } from 'react';
import { createRoot } from 'react-dom/client';
import { RouterProvider, createRouter } from '@tanstack/react-router';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { routeTree } from './routeTree.gen';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5,
      retry: 2,
    }
  }
});

const router = createRouter({
  routeTree,
  context: { queryClient },  // Router context for loader access to QueryClient
  defaultPreload: 'intent',  // Preload on hover
  defaultPreloadStaleTime: 0,
});

declare module '@tanstack/react-router' {
  interface Register { router: typeof router }
}

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <QueryClientProvider client={queryClient}>
      <RouterProvider router={router} />
    </QueryClientProvider>
  </StrictMode>
);
```

```typescript
// Route with loader example â€” apps/web/src/routes/lobby/$roomCode.tsx
import { createFileRoute } from '@tanstack/react-router';
import { roomQueryOptions } from '@/queries/room.queries';

export const Route = createFileRoute('/lobby/$roomCode')({
  loader: ({ context: { queryClient }, params: { roomCode } }) =>
    queryClient.ensureQueryData(roomQueryOptions(roomCode)),
  component: LobbyPage,
});
```

---

## TYPED API CLIENT (native fetch)

```typescript
// apps/web/src/lib/api.ts
// Fully typed fetch wrapper â€” no axios

const API_BASE = import.meta.env.VITE_API_URL;

type ApiResponse<T> = { data: T; error: null } | { data: null; error: string };

async function apiFetch<T>(
  path: string,
  init?: RequestInit
): Promise<ApiResponse<T>> {
  try {
    const res = await fetch(`${API_BASE}${path}`, {
      ...init,
      headers: {
        'Content-Type': 'application/json',
        ...init?.headers,
      },
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({ message: res.statusText }));
      return { data: null, error: err.message ?? 'Unknown error' };
    }
    return { data: await res.json() as T, error: null };
  } catch (e) {
    return { data: null, error: (e as Error).message };
  }
}

// Typed endpoints
export const api = {
  quiz: {
    create: (body: CreateQuizBody) =>
      apiFetch<CreateQuizResponse>('/quiz/create', { method: 'POST', body: JSON.stringify(body) }),
    join: (body: JoinQuizBody) =>
      apiFetch<JoinQuizResponse>('/quiz/join', { method: 'POST', body: JSON.stringify(body) }),
    answer: (body: AnswerBody) =>
      apiFetch<AnswerResponse>('/quiz/answer', { method: 'POST', body: JSON.stringify(body) }),
  },
  room: {
    get: (code: string) => apiFetch<Room>(`/room/${code}`),
    update: (code: string, body: Partial<RoomSettings>) =>
      apiFetch<Room>(`/room/${code}`, { method: 'PATCH', body: JSON.stringify(body) }),
  },
  music: {
    search: (query: string, category: string) =>
      apiFetch<NormalizedTrack[]>(`/music/search?q=${encodeURIComponent(query)}&category=${category}`),
  },
};
```

---

## TANSTACK QUERY â€” QUERY OPTIONS PATTERN

```typescript
// apps/web/src/queries/room.queries.ts
import { queryOptions, infiniteQueryOptions } from '@tanstack/react-query';
import { api } from '@/lib/api';

export const roomQueryOptions = (code: string) =>
  queryOptions({
    queryKey: ['room', code],
    queryFn: async () => {
      const { data, error } = await api.room.get(code);
      if (error) throw new Error(error);
      return data;
    },
    staleTime: 0,      // Always fresh for game state
    refetchInterval: false, // Use Realtime websocket instead of polling
  });

export const tracksQueryOptions = (category: string) =>
  queryOptions({
    queryKey: ['tracks', category],
    queryFn: async () => {
      const { data, error } = await api.music.search('', category);
      if (error) throw new Error(error);
      return data;
    },
    staleTime: 1000 * 60 * 60, // 1h â€” track list doesn't change often
  });
```

---

## ELYSIA BACKEND ENTRY

```typescript
// apps/api/src/index.ts
import { Elysia } from 'elysia';
import { cors } from '@elysiajs/cors';
import { jwt } from '@elysiajs/jwt';
import { quizRoutes } from './routes/quiz';
import { roomRoutes } from './routes/room';
import { musicRoutes } from './routes/music/search';
import { authRoutes } from './routes/auth';

const app = new Elysia()
  .use(cors({ origin: process.env.FRONTEND_URL! }))
  .use(jwt({ secret: process.env.JWT_SECRET! }))
  .get('/health', () => ({ status: 'ok', ts: Date.now() }))
  .use(authRoutes)
  .use(quizRoutes)
  .use(roomRoutes)
  .use(musicRoutes)
  .listen(process.env.PORT ?? 3001);

console.log(`ğŸµ API running on port ${app.server?.port}`);

export type App = typeof app; // Export for Eden Treaty type-safe client (optional)
```

---

## DATABASE SCHEMA

```sql
-- supabase/migrations/001_initial.sql

CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  avatar_url TEXT,
  is_premium BOOLEAN DEFAULT false,
  stripe_customer_id TEXT,
  total_score INTEGER DEFAULT 0,
  games_played INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE tracks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  artist TEXT NOT NULL,
  album TEXT,
  categories TEXT[] DEFAULT '{}',

  -- All provider IDs
  spotify_id TEXT UNIQUE,
  deezer_id TEXT UNIQUE,
  apple_id TEXT UNIQUE,
  tidal_id TEXT UNIQUE,

  -- Preview URLs (ordered by provider preference)
  preview_urls JSONB DEFAULT '[]',
  -- format: [{ "provider": "spotify", "url": "..." }, ...]

  -- Video
  youtube_video_id TEXT,
  youtube_start_time INTEGER DEFAULT 0,

  -- Metadata
  difficulty INTEGER DEFAULT 1 CHECK (difficulty BETWEEN 1 AND 3),
  release_year INTEGER,
  popularity INTEGER DEFAULT 0,

  cached_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE rooms (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code TEXT UNIQUE NOT NULL,
  host_id UUID REFERENCES profiles(id),
  status TEXT DEFAULT 'waiting' CHECK (status IN ('waiting','playing','finished')),
  settings JSONB DEFAULT '{
    "max_players": 10,
    "rounds": 10,
    "round_duration": 20,
    "categories": [],
    "difficulty": 1,
    "show_video_clip": true,
    "video_duration": 20,
    "answer_mode": "free_text"
  }',
  current_round INTEGER DEFAULT 0,
  track_ids UUID[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  finished_at TIMESTAMPTZ
);

CREATE TABLE room_players (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  display_name TEXT NOT NULL,
  avatar_emoji TEXT DEFAULT 'ğŸµ',
  score INTEGER DEFAULT 0,
  streak INTEGER DEFAULT 0,
  is_ready BOOLEAN DEFAULT false,
  is_connected BOOLEAN DEFAULT true,
  is_guest BOOLEAN DEFAULT false,
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(room_id, user_id)
);

CREATE TABLE answers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  room_id UUID REFERENCES rooms(id) ON DELETE CASCADE,
  player_id UUID REFERENCES room_players(id) ON DELETE CASCADE,
  track_id UUID REFERENCES tracks(id),
  round_number INTEGER NOT NULL,
  answer_text TEXT,
  is_correct BOOLEAN DEFAULT false,
  points_earned INTEGER DEFAULT 0,
  time_remaining_ms INTEGER,
  submitted_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_tracks_categories ON tracks USING GIN(categories);
CREATE INDEX idx_tracks_cached ON tracks(cached_at) WHERE youtube_video_id IS NOT NULL;
CREATE INDEX idx_rooms_code ON rooms(code) WHERE status != 'finished';
CREATE INDEX idx_room_players_room ON room_players(room_id);

-- RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE room_players ENABLE ROW LEVEL SECURITY;
ALTER TABLE answers ENABLE ROW LEVEL SECURITY;
ALTER TABLE tracks ENABLE ROW LEVEL SECURITY;

-- Tracks readable by all
CREATE POLICY "tracks_read_all" ON tracks FOR SELECT USING (true);
-- Rooms readable by participants
CREATE POLICY "rooms_read_participants" ON rooms FOR SELECT
  USING (id IN (SELECT room_id FROM room_players WHERE user_id = auth.uid()));
-- Host can update room
CREATE POLICY "rooms_update_host" ON rooms FOR UPDATE
  USING (host_id = auth.uid());
-- Players readable by room participants
CREATE POLICY "players_read_room" ON room_players FOR SELECT
  USING (room_id IN (SELECT room_id FROM room_players WHERE user_id = auth.uid()));
-- Answers: own answers always, all answers in finished room
CREATE POLICY "answers_read_own" ON answers FOR SELECT
  USING (player_id IN (SELECT id FROM room_players WHERE user_id = auth.uid()));

-- Realtime
ALTER PUBLICATION supabase_realtime ADD TABLE rooms;
ALTER PUBLICATION supabase_realtime ADD TABLE room_players;
ALTER PUBLICATION supabase_realtime ADD TABLE answers;
```

---

## RAILWAY DEPLOYMENT

```toml
# railway.toml (root)
[build]
builder = "nixpacks"

[[services]]
name = "web"
source = "apps/web"
buildCommand = "bun run build"
startCommand = "bunx serve dist -p $PORT"

[[services]]
name = "api"
source = "apps/api"
buildCommand = "bun run build"
startCommand = "bun run dist/index.js"
healthcheckPath = "/health"
```

```yaml
# .github/workflows/deploy-api.yml
name: Deploy API
on:
  push:
    branches: [main]
    paths: ['apps/api/**', 'packages/shared/**']
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: railwayapp/railway-github-action@v1
        with:
          service: api
          token: ${{ secrets.RAILWAY_TOKEN }}
```

```yaml
# .github/workflows/deploy-web.yml
name: Deploy Web
on:
  push:
    branches: [main]
    paths: ['apps/web/**', 'packages/shared/**']
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: railwayapp/railway-github-action@v1
        with:
          service: web
          token: ${{ secrets.RAILWAY_TOKEN }}
```

---

## ENVIRONMENT VARIABLES

```env
# apps/api/.env
# Supabase
SUPABASE_URL=
SUPABASE_SERVICE_ROLE_KEY=
SUPABASE_ANON_KEY=

# Spotify
SPOTIFY_CLIENT_ID=
SPOTIFY_CLIENT_SECRET=

# Deezer (no auth needed for public API)
DEEZER_APP_ID=

# Apple Music
APPLE_TEAM_ID=
APPLE_KEY_ID=
APPLE_PRIVATE_KEY=       # PEM format, base64 encoded

# Tidal
TIDAL_CLIENT_ID=
TIDAL_CLIENT_SECRET=

# YouTube
YOUTUBE_API_KEY=

# Upstash Redis (cache)
UPSTASH_REDIS_REST_URL=
UPSTASH_REDIS_REST_TOKEN=

# Stripe
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=

# App
FRONTEND_URL=http://localhost:5173
JWT_SECRET=
PORT=3001
```

```env
# apps/web/.env
VITE_API_URL=http://localhost:3001
VITE_SUPABASE_URL=
VITE_SUPABASE_ANON_KEY=
VITE_STRIPE_PUBLISHABLE_KEY=
```

---

## GAME LOGIC (implement fully)

### Room Code Generation
```
6 chars: consonants + digits, no ambiguous chars (0/O, 1/I/l)
Consonants pool: B C D F G H J K M N P R S T V W Z
Digits pool: 2 3 4 5 6 7 8 9
Example: "BKD427", "WMP839"
```

### State Machine
```
WAITING â†’ COUNTDOWN(3s) â†’ PLAYING(N seconds) â†’ REVEALING(3s) â†’ VIDEO(20s) â†’ NEXT_ROUND | FINAL_RESULTS

Clock sync: host sends { roundStartTimestamp: Date.now() }
All clients compute: timeLeft = settings.roundDuration - (Date.now() - roundStartTimestamp) / 1000
```

### Scoring
```typescript
const calculatePoints = (
  isCorrect: boolean,
  timeRemainingMs: number,
  totalTimeMs: number,
  streak: number
): number => {
  if (!isCorrect) return 0;
  const base = 1000;
  const speed = Math.floor((timeRemainingMs / totalTimeMs) * 500);
  const streakBonus = Math.min(streak * 100, 300);
  return base + speed + streakBonus;
};
```

### Answer Fuzzy Matching
```
- Case insensitive + strip accents (cafÃ© â†’ cafe)
- Levenshtein distance â‰¤ 2 for typos
- Accept artist name OR song title alone
- Strip common words: "the", "feat.", "ft.", "(official)", "live"
- Accept partial match if â‰¥ 70% of chars correct
```

---

## MUSIC CATEGORIES

```typescript
// packages/shared/src/constants.ts
export const CATEGORIES = [
  { id: 'anime-opening', label: 'ğŸŒ Anime Openings',   query: 'anime opening' },
  { id: 'anime-ending',  label: 'ğŸŒ¸ Anime Endings',    query: 'anime ending' },
  { id: 'jpop',          label: 'ğŸ‡¯ğŸ‡µ J-Pop',           query: 'jpop japanese pop' },
  { id: 'kpop',          label: 'ğŸ‡°ğŸ‡· K-Pop',           query: 'kpop hits' },
  { id: 'pop-fr',        label: 'ğŸ‡«ğŸ‡· Pop FranÃ§aise',   query: 'variete francaise hits' },
  { id: 'pop-en',        label: 'ğŸ¤ Pop',              query: 'pop hits english' },
  { id: 'rock',          label: 'ğŸ¸ Rock',             query: 'rock classic hits' },
  { id: 'hiphop-fr',     label: 'ğŸ¤ Rap FranÃ§ais',     query: 'rap francais hits' },
  { id: 'hiphop-en',     label: 'ğŸ§ Hip-Hop',          query: 'hiphop rap hits' },
  { id: '80s',           label: 'ğŸ“» AnnÃ©es 80',        query: '80s hits nostalgia' },
  { id: '90s',           label: 'ğŸ“¼ AnnÃ©es 90',        query: '90s hits nostalgia' },
  { id: '2000s',         label: 'ğŸ’¿ AnnÃ©es 2000',      query: '2000s hits nostalgia' },
  { id: 'electro',       label: 'ğŸ›ï¸ Ã‰lectro / House',  query: 'electronic dance music' },
  { id: 'rnb',           label: 'ğŸ’œ R&B / Soul',       query: 'rnb soul hits' },
  { id: 'gaming',        label: 'ğŸ® Jeux VidÃ©o OST',  query: 'video game soundtrack' },
  { id: 'films',         label: 'ğŸ¬ Films & SÃ©ries',   query: 'movie series soundtrack' },
  { id: 'disney',        label: 'ğŸ° Disney',           query: 'disney songs' },
  { id: 'random',        label: 'ğŸ² Mix Surprise',     query: 'popular hits mix' },
] as const;

export type CategoryId = typeof CATEGORIES[number]['id'];
```

---

## UI/UX (party mobile-first)

```
Design tokens:
- bg: #0D0D1A
- accent: #7C3AED (purple)
- neon: #00FF88 (correct answer flash)
- danger: #FF4757 (wrong answer flash)
- text: #F0EEFF
- muted: #8884A8

All touch targets: min 48x48px
Font: minimum 16px (prevent iOS auto-zoom)
Haptics: navigator.vibrate(80) on tap, [100,50,200] on correct
Sound: Howler.js with global mute toggle always visible
Animations: Motion (spring physics, not linear)
```

### Home (/)
- Two giant buttons: CRÃ‰ER / REJOINDRE
- Animated music visualizer background (CSS only, no canvas)
- Login link small, bottom of screen

### Join (/join)
- Full-screen room code input (very large, auto-uppercase)
- Camera QR scanner button
- "Continuer en tant qu'invitÃ©" â€” ask display name + emoji

### Lobby (/lobby/$roomCode)
- Room code: 72px font, tap to copy with toast
- QR code: large, tap to fullscreen
- Player list: animated entrance per player
- Settings panel: host-only, slide-up drawer on mobile
- START button: pulsing when all ready

### Play (/play/$roomCode)
- Waveform animation while audio plays
- Giant countdown ring (SVG stroke-dashoffset animation)
- Answer input OR 4 choice buttons (per settings)
- "X joueurs ont rÃ©pondu" counter

### Video Reveal
- YouTube fullscreen embed
- Slide-up artist/title overlay
- Score delta popup (+1200 ğŸ”¥ or âŒ)
- Host-only SKIP button

### Results (/results/$roomCode)
- Podium 3-2-1 animated reveal
- Confetti (canvas-confetti)
- "Rejouer" + "Quitter"
- Share card (html2canvas screenshot)

---

## ADDITIONAL FEATURES

1. **QR Code**: `qrcode.react` in lobby â€” large, tap to fullscreen
2. **PWA**: `manifest.json` + service worker (offline lobby page)
3. **Reconnection**: store roomCode in sessionStorage, auto-rejoin on refresh
4. **Guest mode**: sessionStorage only, "Save your score?" CTA after game
5. **Confetti**: `canvas-confetti` on correct answer + podium reveal
6. **Haptics**: all key interactions
7. **Skeleton screens**: all loading states
8. **Error boundaries**: per-route, with retry button

---

## DELIVERABLES â€” generate in this order

1. `package.json` (root + each app/package)
2. `packages/shared/src/` â€” all shared types, constants, events
3. `supabase/migrations/001_initial.sql`
4. `apps/api/src/` â€” all backend files (Elysia routes, services, lib)
5. `apps/web/src/` â€” all frontend files (routes, components, hooks, stores, queries)
6. Config files: `vite.config.ts`, `tsconfig.json` (all), `.oxlintrc.json`, `biome.json`, `bunfig.toml`, `railway.toml`
7. `.github/workflows/` â€” CI/CD files
8. `.env.example` (web + api)
9. `README.md` â€” full setup guide (Supabase, all music APIs, Railway, GitHub Actions)

## QUALITY REQUIREMENTS

- Zero `any` TypeScript â€” use `unknown` + type guards
- `noUncheckedIndexedAccess: true` â€” all array accesses checked
- All async functions: typed `try/catch` with specific error types
- Mobile-first CSS: 375px base, no hover-only states
- All interactive elements: loading + disabled states
- TanStack Router: use loaders for data prefetch, not `useEffect`
- React 19: prefer `use()` for async data in components where appropriate
- Elysia: use Eden Treaty types for end-to-end type safety if applicable
